{"title":"自建日志聚合系统","uid":"6f86069348c95b8be65f6c4b03028387","slug":"自建日志聚合系统","date":"2024-03-01T09:37:02.000Z","updated":"2024-03-01T11:46:35.425Z","comments":true,"path":"api/articles/自建日志聚合系统.json","keywords":null,"cover":[],"content":"<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>💡 Tips：Loki 是受 Prometheus 启发的水平可扩展、高可用、多租户日志聚合系统。它被设计得非常轻量高效且易于操作。因为它不会为日志内容创建索引，而是为每个日志流配置一组标签。</p></blockquote>\n<h3 id=\"Loki-组成\"><a href=\"#Loki-组成\" class=\"headerlink\" title=\"Loki 组成\"></a>Loki 组成</h3><ul>\n<li>Loki 是主服务器，负责存储日志和处理查询；</li>\n<li>Promtail 是代理，负责收集日志并发送给 Loki；</li>\n<li>Grafana 用于查询和显示日志的 UI 界面；</li>\n</ul>\n<h3 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h3><h4 id=\"dokcer-compose\"><a href=\"#dokcer-compose\" class=\"headerlink\" title=\"dokcer-compose\"></a>dokcer-compose</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://raw.githubusercontent.com/grafana/loki/v2.3.0/production/docker-compose.yaml -O docker-compose.yaml</span><br><span class=\"line\">docker-compose -f docker-compose.yaml up</span><br></pre></td></tr></table></figure>\n\n<p>安装完成后，执行 docker 命令查看容器是否正常运行：</p>\n<div align=center><img src=\"https://cdn.jsdelivr.net/gh/NezhaGrin/MyImages/20240301190324.png\"></div>\n\n<h4 id=\"登录-Grafana\"><a href=\"#登录-Grafana\" class=\"headerlink\" title=\"登录 Grafana\"></a>登录 Grafana</h4><p>登陆 Grafana 如果是本地那么就是：127.0.0.1:3000，如果是服务器那么就是服务器的 IP 地址加上 3000 的端口号。ps：登陆账号密码都是：admin，另外如果是服务器要看下 3000 端口是否在防火墙当中打开。</p>\n<div align=center><img src=\"https://cdn.jsdelivr.net/gh/NezhaGrin/MyImages/20240301190450.png\"></div>\n\n<h3 id=\"配置\"><a href=\"#配置\" class=\"headerlink\" title=\"配置\"></a>配置</h3><div align=center><img src=\"https://cdn.jsdelivr.net/gh/NezhaGrin/MyImages/BNjB6x.png\"></div>\n<br>\n<div align=center><img src=\"https://cdn.jsdelivr.net/gh/NezhaGrin/MyImages/2kuRAa.png\"></div>\n<br>\n<div align=center><img src=\"https://cdn.jsdelivr.net/gh/NezhaGrin/MyImages/10SXKQ.png\"></div>\n\n<h3 id=\"使用\"><a href=\"#使用\" class=\"headerlink\" title=\"使用\"></a>使用</h3><h4 id=\"Promtail-自动推送\"><a href=\"#Promtail-自动推送\" class=\"headerlink\" title=\"Promtail 自动推送\"></a>Promtail 自动推送</h4><p>Promtail 是将本地日志内容传送到私有 Loki 实例或 Grafana Cloud 的代理。它通常部署到每台具有需要监控的应用程序的机器上。</p>\n<div align=center><img src=\"https://cdn.jsdelivr.net/gh/NezhaGrin/MyImages/WYGJk0.png\"></div>\n\n<p>可以看见 Promtail 映射的本机目录是 &#x2F;home&#x2F;ubuntu&#x2F;loki 那么只需要把 log 文件放到这个映射的目录当中即可。创建了一个测试的 log 文件，随便填写一点内容，现在就可以去 Grafana 当中查询了：</p>\n<div align=center><img src=\"https://cdn.jsdelivr.net/gh/NezhaGrin/MyImages/YRatkL.png\"></div>\n<br>\n<div align=center><img src=\"https://cdn.jsdelivr.net/gh/NezhaGrin/MyImages/P8WgMn.png\"></div>\n\n<div class=\"custom-quote tip\">\n<span class=\"custom-quote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M20.86 14.13C20 14.7 19.56 15.74 19.77 16.76C20.13 18.55 18.55 20.13 16.76 19.77C15.74 19.57 14.7 20 14.13 20.86C13.12 22.38 10.89 22.38 9.88 20.86C9.3 20 8.26 19.56 7.24 19.77C5.45 20.13 3.87 18.55 4.23 16.76C4.43 15.74 4 14.7 3.14 14.13C1.62 13.12 1.62 10.89 3.14 9.88C4 9.3 4.44 8.26 4.23 7.24C3.87 5.45 5.45 3.87 7.24 4.23C8.26 4.44 9.3 4 9.87 3.14C10.88 1.62 13.11 1.62 14.12 3.14C14.7 4 15.74 4.44 16.76 4.23C18.55 3.87 20.13 5.45 19.77 7.24C19.56 8.26 20 9.3 20.86 9.87C22.38 10.88 22.38 13.12 20.86 14.13Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M12.01 15C12.01 14.5 12.01 14.5 12.01 14.5C12.04 13.75 13 13.46 14.04 12.2C14.41 11.74 14.69 11.41 14.86 10.85C15.15 9.95 14.92 9.18 14.86 9.02C14.8 8.79 14.52 8 13.72 7.46C13.06 7.02 12.42 7 12.14 7C11.9 7 11.36 7 10.78 7.3C10.28 7.56 9.98 7.9 9.83 8.1C9.24 8.82 9.06 9.63 9 10.06\"></path>\n<path stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M11.99 18H12.01\"></path>\n</svg></span>\n<p class=\"custom-quote-title\">TIP</p>\n<p>Promtail 本地处理就是这么简单！安装好 Promtail 映射好目录，把日志放到映射好的目录当中就完成了。其它什么都不用管，Promtail 会自动推送给 Loki 就是这么简单易用！非常复合 Loki 对自己的介绍：<em>它被设计得非常轻量高效且易于操作!</em></p>\n</div>\n<h4 id=\"Promtail-集群配置\"><a href=\"#Promtail-集群配置\" class=\"headerlink\" title=\"Promtail 集群配置\"></a>Promtail 集群配置</h4><p>这里演示的是单机，Loki 和 Promtail 都是一台机器，如果多台机器那么就需要修改 Promtail 的配置文件：</p>\n<div align=center><img src=\"https://cdn.jsdelivr.net/gh/NezhaGrin/MyImages/20240301192941.png\"></div>\n\n<h4 id=\"Loki-API-推送日志\"><a href=\"#Loki-API-推送日志\" class=\"headerlink\" title=\"Loki API 推送日志\"></a>Loki API 推送日志</h4><p>以上都是 Promtail 做为 Loki 的客户端使用，另外可以使用 HTTP API 的方式绕过 Promtail 直接与 Loki 交互。关闭 Promtail 容器，开始 HTTP API 方式使用交互：</p>\n<div align=center><img src=\"https://cdn.jsdelivr.net/gh/NezhaGrin/MyImages/20240301193015.png\"></div>\n\n<div class=\"custom-quote tip\">\n<span class=\"custom-quote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M20.86 14.13C20 14.7 19.56 15.74 19.77 16.76C20.13 18.55 18.55 20.13 16.76 19.77C15.74 19.57 14.7 20 14.13 20.86C13.12 22.38 10.89 22.38 9.88 20.86C9.3 20 8.26 19.56 7.24 19.77C5.45 20.13 3.87 18.55 4.23 16.76C4.43 15.74 4 14.7 3.14 14.13C1.62 13.12 1.62 10.89 3.14 9.88C4 9.3 4.44 8.26 4.23 7.24C3.87 5.45 5.45 3.87 7.24 4.23C8.26 4.44 9.3 4 9.87 3.14C10.88 1.62 13.11 1.62 14.12 3.14C14.7 4 15.74 4.44 16.76 4.23C18.55 3.87 20.13 5.45 19.77 7.24C19.56 8.26 20 9.3 20.86 9.87C22.38 10.88 22.38 13.12 20.86 14.13Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M12.01 15C12.01 14.5 12.01 14.5 12.01 14.5C12.04 13.75 13 13.46 14.04 12.2C14.41 11.74 14.69 11.41 14.86 10.85C15.15 9.95 14.92 9.18 14.86 9.02C14.8 8.79 14.52 8 13.72 7.46C13.06 7.02 12.42 7 12.14 7C11.9 7 11.36 7 10.78 7.3C10.28 7.56 9.98 7.9 9.83 8.1C9.24 8.82 9.06 9.63 9 10.06\"></path>\n<path stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M11.99 18H12.01\"></path>\n</svg></span>\n<p class=\"custom-quote-title\">TIP</p>\n<p>Loki HTTP API 官方文档地址：<a href=\"https://grafana.com/docs/loki/latest/api/#post-lokiapiv1push%E3%80%82/loki/api/v1/push%EF%BC%9A%E6%98%AF%E7%94%A8%E4%BA%8E%E5%90%91\">https://grafana.com/docs/loki/latest/api/#post-lokiapiv1push。/loki/api/v1/push：是用于向</a> Loki 发送日志条目的端点。默认行为是 POST 正文是一个快速压缩的 protobuf 消息。</p>\n</div>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;streams&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;stream&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;label&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;value&quot;</span></span><br><span class=\"line\">      <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;values&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">          <span class=\"punctuation\">[</span> <span class=\"string\">&quot;&lt;unix epoch in nanoseconds&gt;&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;&lt;log line&gt;&quot;</span> <span class=\"punctuation\">]</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">          <span class=\"punctuation\">[</span> <span class=\"string\">&quot;&lt;unix epoch in nanoseconds&gt;&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;&lt;log line&gt;&quot;</span> <span class=\"punctuation\">]</span></span><br><span class=\"line\">      <span class=\"punctuation\">]</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  <span class=\"punctuation\">]</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<div class=\"custom-quote tip\">\n<span class=\"custom-quote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M20.86 14.13C20 14.7 19.56 15.74 19.77 16.76C20.13 18.55 18.55 20.13 16.76 19.77C15.74 19.57 14.7 20 14.13 20.86C13.12 22.38 10.89 22.38 9.88 20.86C9.3 20 8.26 19.56 7.24 19.77C5.45 20.13 3.87 18.55 4.23 16.76C4.43 15.74 4 14.7 3.14 14.13C1.62 13.12 1.62 10.89 3.14 9.88C4 9.3 4.44 8.26 4.23 7.24C3.87 5.45 5.45 3.87 7.24 4.23C8.26 4.44 9.3 4 9.87 3.14C10.88 1.62 13.11 1.62 14.12 3.14C14.7 4 15.74 4.44 16.76 4.23C18.55 3.87 20.13 5.45 19.77 7.24C19.56 8.26 20 9.3 20.86 9.87C22.38 10.88 22.38 13.12 20.86 14.13Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M12.01 15C12.01 14.5 12.01 14.5 12.01 14.5C12.04 13.75 13 13.46 14.04 12.2C14.41 11.74 14.69 11.41 14.86 10.85C15.15 9.95 14.92 9.18 14.86 9.02C14.8 8.79 14.52 8 13.72 7.46C13.06 7.02 12.42 7 12.14 7C11.9 7 11.36 7 10.78 7.3C10.28 7.56 9.98 7.9 9.83 8.1C9.24 8.82 9.06 9.63 9 10.06\"></path>\n<path stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M11.99 18H12.01\"></path>\n</svg></span>\n<p class=\"custom-quote-title\">TIP</p>\n<ul>\n<li>stream 下面的内容就是自己的标签内容，随便自定义如：game:dev；</li>\n<li>values 就是日志的内容，需要注意一点，values 里面必须要有一个 unix 的时间戳；</li>\n</ul>\n\n</div>\n<p>Loki 是通过流的传输，当成功推流后正常情况下 Loki 是没有任何实体响应的，也就是说推流成功我们得到的 HTTP 状态应该为 204。</p>\n<div align=center><img src=\"https://cdn.jsdelivr.net/gh/NezhaGrin/MyImages/720a0090b893c59dc564643e4c0c617.png\"></div>\n<br>\n<div align=center><img src=\"https://cdn.jsdelivr.net/gh/NezhaGrin/MyImages/20240301194529.png\"></div>\n<br>\n<div align=center><img src=\"https://cdn.jsdelivr.net/gh/NezhaGrin/MyImages/20240301194548.png\"></div>","text":"Loki 是受 Prometheus 启发的水平可扩展、高可用、多租户日志聚合系统。它被设计得非常轻量高效且易于操作。因为它不会为日志内容创建索引，而是为每个日志流配置一组标签。...","permalink":"/post/自建日志聚合系统","photos":[],"count_time":{"symbolsCount":"1.8k","symbolsTime":"2 mins."},"categories":[],"tags":[{"name":"日志系统","slug":"日志系统","count":1,"path":"api/tags/日志系统.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#Loki-%E7%BB%84%E6%88%90\"><span class=\"toc-text\">Loki 组成</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%AE%89%E8%A3%85\"><span class=\"toc-text\">安装</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#dokcer-compose\"><span class=\"toc-text\">dokcer-compose</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E7%99%BB%E5%BD%95-Grafana\"><span class=\"toc-text\">登录 Grafana</span></a></li></ol></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E9%85%8D%E7%BD%AE\"><span class=\"toc-text\">配置</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E4%BD%BF%E7%94%A8\"><span class=\"toc-text\">使用</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#Promtail-%E8%87%AA%E5%8A%A8%E6%8E%A8%E9%80%81\"><span class=\"toc-text\">Promtail 自动推送</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#Promtail-%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AE\"><span class=\"toc-text\">Promtail 集群配置</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#Loki-API-%E6%8E%A8%E9%80%81%E6%97%A5%E5%BF%97\"><span class=\"toc-text\">Loki API 推送日志</span></a></li></ol></li></ol>","author":{"name":"哪吒","slug":"blog-author","avatar":"https://pic.imgdb.cn/item/65ba193b871b83018a65323c.jpg","link":"/","description":"人心中的成见就像一座大山，任你怎么努力也休想搬动。","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"hidden":false,"prev_post":{"title":"Laravel 配置多环境 Env 文件","uid":"5b2c3990e729e0dcdbbde8d888ffbc29","slug":"Laravel-配置多环境-Env-文件","date":"2024-03-02T04:50:53.000Z","updated":"2024-03-02T05:42:32.811Z","comments":true,"path":"api/articles/Laravel-配置多环境-Env-文件.json","keywords":null,"cover":[],"text":"在实际的项目当中，一个项目拥有多个环境是一个很正常的情况。当存在多个环境的情况下，在 Laravel 当中只需要配置多个 env 文件，管理这些 env 文件那么就可以轻松解决这个问题了。...","permalink":"/post/Laravel-配置多环境-Env-文件","photos":[],"count_time":{"symbolsCount":"1.4k","symbolsTime":"1 mins."},"categories":[],"tags":[],"author":{"name":"哪吒","slug":"blog-author","avatar":"https://pic.imgdb.cn/item/65ba193b871b83018a65323c.jpg","link":"/","description":"人心中的成见就像一座大山，任你怎么努力也休想搬动。","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"PHP 实现滑块验证码","uid":"e3f85d15765fb35f42774d665bc192c9","slug":"PHP-实现滑块验证码","date":"2024-03-01T09:36:48.000Z","updated":"2024-03-01T10:57:39.268Z","comments":true,"path":"api/articles/PHP-实现滑块验证码.json","keywords":null,"cover":[],"text":"PHP 实现滑动块验证码。...","permalink":"/post/PHP-实现滑块验证码","photos":[],"count_time":{"symbolsCount":"6.9k","symbolsTime":"6 mins."},"categories":[],"tags":[{"name":"PHP","slug":"PHP","count":5,"path":"api/tags/PHP.json"}],"author":{"name":"哪吒","slug":"blog-author","avatar":"https://pic.imgdb.cn/item/65ba193b871b83018a65323c.jpg","link":"/","description":"人心中的成见就像一座大山，任你怎么努力也休想搬动。","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}}}