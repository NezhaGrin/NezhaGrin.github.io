{"title":"MySQL 分析 SQL 性能","uid":"c590da9e3fbc0033731d8478ad40382b","slug":"MySQL-分析-SQL-性能","date":"2024-02-28T04:40:33.000Z","updated":"2024-03-01T09:30:20.267Z","comments":true,"path":"api/articles/MySQL-分析-SQL-性能.json","keywords":null,"cover":[],"content":"<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>💡 Tips：分析 SQL 语句性能是每个后端开发都应该熟悉的知识。MySQL 提供了：慢查询日志、profile、explain 来帮助分析 SQL 语句性能。</p></blockquote>\n<h3 id=\"慢查询日志\"><a href=\"#慢查询日志\" class=\"headerlink\" title=\"慢查询日志\"></a>慢查询日志</h3><p>慢查询日志是 MySQL 提供记录超过时间限定 SQL 语句的一个日志功能，查询日志，有利于我们进行 SQL 的分析。</p>\n<h4 id=\"查询\"><a href=\"#查询\" class=\"headerlink\" title=\"查询\"></a>查询</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 查看是否开启了慢查询</span><br><span class=\"line\">show variables like &#x27;slow_query_log%&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\"># 查看默认触发记录的时间 单位：秒  默认10秒</span><br><span class=\"line\">show variables like &#x27;long_query_time&#x27;;</span><br></pre></td></tr></table></figure>\n\n<div align=center><img src=\"https://cdn.jsdelivr.net/gh/NezhaGrin/MyImages/20240301171232.png\"></div>\n\n<div class=\"custom-quote tip\">\n<span class=\"custom-quote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M20.86 14.13C20 14.7 19.56 15.74 19.77 16.76C20.13 18.55 18.55 20.13 16.76 19.77C15.74 19.57 14.7 20 14.13 20.86C13.12 22.38 10.89 22.38 9.88 20.86C9.3 20 8.26 19.56 7.24 19.77C5.45 20.13 3.87 18.55 4.23 16.76C4.43 15.74 4 14.7 3.14 14.13C1.62 13.12 1.62 10.89 3.14 9.88C4 9.3 4.44 8.26 4.23 7.24C3.87 5.45 5.45 3.87 7.24 4.23C8.26 4.44 9.3 4 9.87 3.14C10.88 1.62 13.11 1.62 14.12 3.14C14.7 4 15.74 4.44 16.76 4.23C18.55 3.87 20.13 5.45 19.77 7.24C19.56 8.26 20 9.3 20.86 9.87C22.38 10.88 22.38 13.12 20.86 14.13Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M12.01 15C12.01 14.5 12.01 14.5 12.01 14.5C12.04 13.75 13 13.46 14.04 12.2C14.41 11.74 14.69 11.41 14.86 10.85C15.15 9.95 14.92 9.18 14.86 9.02C14.8 8.79 14.52 8 13.72 7.46C13.06 7.02 12.42 7 12.14 7C11.9 7 11.36 7 10.78 7.3C10.28 7.56 9.98 7.9 9.83 8.1C9.24 8.82 9.06 9.63 9 10.06\"></path>\n<path stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M11.99 18H12.01\"></path>\n</svg></span>\n<p class=\"custom-quote-title\">TIP</p>\n<p>慢查询日志默认没有开启，慢查询日志开启方式有两种：临时开启和永久开启，开启永久慢查询需要重启。</p>\n</div>\n<h4 id=\"临时开启\"><a href=\"#临时开启\" class=\"headerlink\" title=\"临时开启\"></a>临时开启</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 开启</span><br><span class=\"line\">set global slow_query_log = 1;  </span><br><span class=\"line\"></span><br><span class=\"line\"># 修改触发时间</span><br><span class=\"line\">set long_query_time = 10;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"永久开启\"><a href=\"#永久开启\" class=\"headerlink\" title=\"永久开启\"></a>永久开启</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 修改配置 mysql 下的配置文件,开启慢查询</span><br><span class=\"line\">slow_query_log = 1</span><br><span class=\"line\"></span><br><span class=\"line\"># 慢查询日志记录的位置</span><br><span class=\"line\">log-slow-queries = &quot;/var/lib/mysql/slow.log&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"># 触发的时间</span><br><span class=\"line\">long_query_time = 1 </span><br><span class=\"line\"></span><br><span class=\"line\"># 不记录没有使用索引的日志</span><br><span class=\"line\">log-queries-not-using-indexes</span><br></pre></td></tr></table></figure>\n\n<div align=center><img src=\"https://cdn.jsdelivr.net/gh/NezhaGrin/MyImages/20240301171549.png\"></div>\n\n<h4 id=\"日志查看\"><a href=\"#日志查看\" class=\"headerlink\" title=\"日志查看\"></a>日志查看</h4><div align=center><img src=\"https://cdn.jsdelivr.net/gh/NezhaGrin/MyImages/20240301171707.png\"></div>\n\n<div class=\"custom-quote tip\">\n<span class=\"custom-quote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M20.86 14.13C20 14.7 19.56 15.74 19.77 16.76C20.13 18.55 18.55 20.13 16.76 19.77C15.74 19.57 14.7 20 14.13 20.86C13.12 22.38 10.89 22.38 9.88 20.86C9.3 20 8.26 19.56 7.24 19.77C5.45 20.13 3.87 18.55 4.23 16.76C4.43 15.74 4 14.7 3.14 14.13C1.62 13.12 1.62 10.89 3.14 9.88C4 9.3 4.44 8.26 4.23 7.24C3.87 5.45 5.45 3.87 7.24 4.23C8.26 4.44 9.3 4 9.87 3.14C10.88 1.62 13.11 1.62 14.12 3.14C14.7 4 15.74 4.44 16.76 4.23C18.55 3.87 20.13 5.45 19.77 7.24C19.56 8.26 20 9.3 20.86 9.87C22.38 10.88 22.38 13.12 20.86 14.13Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M12.01 15C12.01 14.5 12.01 14.5 12.01 14.5C12.04 13.75 13 13.46 14.04 12.2C14.41 11.74 14.69 11.41 14.86 10.85C15.15 9.95 14.92 9.18 14.86 9.02C14.8 8.79 14.52 8 13.72 7.46C13.06 7.02 12.42 7 12.14 7C11.9 7 11.36 7 10.78 7.3C10.28 7.56 9.98 7.9 9.83 8.1C9.24 8.82 9.06 9.63 9 10.06\"></path>\n<path stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M11.99 18H12.01\"></path>\n</svg></span>\n<p class=\"custom-quote-title\">TIP</p>\n<ul>\n<li>Time：当前数据库时间；</li>\n<li>User@Host：数据库用户的一些信息；</li>\n<li>Id：是执行查询的线程 Id；</li>\n<li>Query_time：执行 SQL 所需要的时间，单位秒；</li>\n<li>Lock_time：执行查询对记录锁定的时间；</li>\n<li>Rows_sent：查询返回的行数；</li>\n<li>Rows_examined：为了返回查询的数据所读取的行数；</li>\n</ul>\n\n</div>\n<h3 id=\"Profile\"><a href=\"#Profile\" class=\"headerlink\" title=\"Profile\"></a>Profile</h3><p>profile 也称之为精准时间记录，profile 记录每次执行的 SQL 语句的具体时间，精确时间到小数点 8 位。</p>\n<h4 id=\"开启\"><a href=\"#开启\" class=\"headerlink\" title=\"开启\"></a>开启</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 开启profile记录</span><br><span class=\"line\">set profiling = 1;</span><br><span class=\"line\"></span><br><span class=\"line\"># 关闭</span><br><span class=\"line\">set profiling = 0;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"查询-1\"><a href=\"#查询-1\" class=\"headerlink\" title=\"查询\"></a>查询</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">show profiles;</span><br></pre></td></tr></table></figure>\n\n<div align=center><img src=\"https://cdn.jsdelivr.net/gh/NezhaGrin/MyImages/20240301172036.png\"></div>\n\n<h3 id=\"Explain\"><a href=\"#Explain\" class=\"headerlink\" title=\"Explain\"></a>Explain</h3><p>explain 也称之为计划任务，explain 可以模拟 MySQL 优化器执行 SQL 语句，可以很好的分析 SQL 语句。</p>\n<h4 id=\"执行\"><a href=\"#执行\" class=\"headerlink\" title=\"执行\"></a>执行</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">mysql&gt;</span> <span class=\"string\">explain</span> <span class=\"string\">select</span> <span class=\"string\">*</span> <span class=\"string\">from</span> <span class=\"string\">`signs`</span> <span class=\"string\">where</span> <span class=\"string\">`id`</span> <span class=\"string\">=</span> <span class=\"string\">&#x27;11&#x27;</span> <span class=\"string\">\\G;</span></span><br><span class=\"line\"><span class=\"string\">***************************</span> <span class=\"number\">1</span><span class=\"string\">.</span> <span class=\"string\">row</span> <span class=\"string\">***************************</span></span><br><span class=\"line\">           <span class=\"attr\">id:</span> <span class=\"number\">1</span></span><br><span class=\"line\">  <span class=\"attr\">select_type:</span> <span class=\"string\">SIMPLE</span></span><br><span class=\"line\">        <span class=\"attr\">table:</span> <span class=\"string\">signs</span></span><br><span class=\"line\">   <span class=\"attr\">partitions:</span> <span class=\"literal\">NULL</span></span><br><span class=\"line\">         <span class=\"attr\">type:</span> <span class=\"string\">const</span></span><br><span class=\"line\"><span class=\"attr\">possible_keys:</span> <span class=\"string\">PRIMARY</span></span><br><span class=\"line\">          <span class=\"attr\">key:</span> <span class=\"string\">PRIMARY</span></span><br><span class=\"line\">      <span class=\"attr\">key_len:</span> <span class=\"number\">8</span></span><br><span class=\"line\">          <span class=\"attr\">ref:</span> <span class=\"string\">const</span></span><br><span class=\"line\">         <span class=\"attr\">rows:</span> <span class=\"number\">1</span></span><br><span class=\"line\">     <span class=\"attr\">filtered:</span> <span class=\"number\">100.00</span></span><br><span class=\"line\">        <span class=\"attr\">Extra:</span> <span class=\"literal\">NULL</span></span><br><span class=\"line\"><span class=\"number\">1</span> <span class=\"string\">row</span> <span class=\"string\">in</span> <span class=\"string\">set,</span> <span class=\"number\">1</span> <span class=\"string\">warning</span> <span class=\"string\">(0.00</span> <span class=\"string\">sec)</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"详解\"><a href=\"#详解\" class=\"headerlink\" title=\"详解\"></a>详解</h4><ul>\n<li>id：select 查询的序列号，包含一组数字，表示查询中执行 select 子句或操作表的顺序；</li>\n<li>select_type ：查询类型；</li>\n<li>table ：正在访问哪个表；</li>\n<li>partitions ：匹配的分区；</li>\n<li>type ：访问的类型；</li>\n<li>possible_keys ：显示可能应用在这张表中的索引，一个或多个，但不一定实际使用到；</li>\n<li>key ：实际使用到的索引，如果为 NULL，则没有使用索引；</li>\n<li>key_len ：表示索引中使用的字节数，可通过该列计算查询中使用的索引的长度；</li>\n<li>ref ：显示索引的哪一列被使用了，如果可能的话，是一个常数，哪些列或常量被用于查找索引列上的值；</li>\n<li>rows ：根据表统计信息及索引选用情况，大致估算出找到所需的记录所需读取的行数；</li>\n<li>filtered ：查询的表行占表的百分比；</li>\n<li>Extra ：包含不适合在其它列中显示但十分重要的额外信息；</li>\n</ul>\n","text":"分析 SQL 语句性能是每个后端开发都应该熟悉的知识。MySQL 提供了：慢查询日志、profile、explain 来帮助分析 SQL 语句性能。...","permalink":"/post/MySQL-分析-SQL-性能","photos":[],"count_time":{"symbolsCount":"1.9k","symbolsTime":"2 mins."},"categories":[],"tags":[{"name":"MySQL","slug":"MySQL","count":4,"path":"api/tags/MySQL.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97\"><span class=\"toc-text\">慢查询日志</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E6%9F%A5%E8%AF%A2\"><span class=\"toc-text\">查询</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E4%B8%B4%E6%97%B6%E5%BC%80%E5%90%AF\"><span class=\"toc-text\">临时开启</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E6%B0%B8%E4%B9%85%E5%BC%80%E5%90%AF\"><span class=\"toc-text\">永久开启</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E6%97%A5%E5%BF%97%E6%9F%A5%E7%9C%8B\"><span class=\"toc-text\">日志查看</span></a></li></ol></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#Profile\"><span class=\"toc-text\">Profile</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E5%BC%80%E5%90%AF\"><span class=\"toc-text\">开启</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E6%9F%A5%E8%AF%A2-1\"><span class=\"toc-text\">查询</span></a></li></ol></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#Explain\"><span class=\"toc-text\">Explain</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E6%89%A7%E8%A1%8C\"><span class=\"toc-text\">执行</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E8%AF%A6%E8%A7%A3\"><span class=\"toc-text\">详解</span></a></li></ol></li></ol>","author":{"name":"哪吒","slug":"blog-author","avatar":"https://pic.imgdb.cn/item/65ba193b871b83018a65323c.jpg","link":"/","description":"人心中的成见就像一座大山，任你怎么努力也休想搬动。","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"hidden":false,"prev_post":{"title":"PHP 多进程定时任务","uid":"a9a874d78a99ce0f41c468a49561eea5","slug":"PHP-多进程定时任务","date":"2024-03-01T09:36:18.000Z","updated":"2024-03-01T10:17:29.817Z","comments":true,"path":"api/articles/PHP-多进程定时任务.json","keywords":null,"cover":null,"text":"Supervisor 是用 python 开发的一个在 Linux 系统下的进程管理工具，可以方便的监听、启动、停止一个或多个进程。使用更加的简单、好管理。...","permalink":"/post/PHP-多进程定时任务","photos":[],"count_time":{"symbolsCount":"6.7k","symbolsTime":"6 mins."},"categories":[],"tags":[{"name":"PHP","slug":"PHP","count":5,"path":"api/tags/PHP.json"}],"author":{"name":"哪吒","slug":"blog-author","avatar":"https://pic.imgdb.cn/item/65ba193b871b83018a65323c.jpg","link":"/","description":"人心中的成见就像一座大山，任你怎么努力也休想搬动。","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"MySQL 唯一索引","uid":"7a38e714a3bfd10e2638b1aa74f75108","slug":"MySQL-唯一索引","date":"2024-02-28T04:38:25.000Z","updated":"2024-02-28T13:33:49.640Z","comments":true,"path":"api/articles/MySQL-唯一索引.json","keywords":null,"cover":null,"text":"在 MySQL 数据库中，唯一性约束（Unique Constraint）是一种非常重要的约束，它可以确保表中的列（字段）不包含重复的值。...","permalink":"/post/MySQL-唯一索引","photos":[],"count_time":{"symbolsCount":684,"symbolsTime":"1 mins."},"categories":[],"tags":[{"name":"MySQL","slug":"MySQL","count":4,"path":"api/tags/MySQL.json"}],"author":{"name":"哪吒","slug":"blog-author","avatar":"https://pic.imgdb.cn/item/65ba193b871b83018a65323c.jpg","link":"/","description":"人心中的成见就像一座大山，任你怎么努力也休想搬动。","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}}}